!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("rxjs/observable/fromEvent"),require("rxjs/add/operator/switchMap"),require("rxjs/add/operator/map")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs/observable/fromEvent","rxjs/add/operator/switchMap","rxjs/add/operator/map"],e):e(t["meepo-idesign-share"]={},t.ng.core,t.Rx.Observable)}(this,function(t,e,r){"use strict";function n(){function t(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()}function o(t){return Array.prototype.concat.apply([],t)}var i=new e.InjectionToken("DESIGN_LIBRARYS"),s=new Map,p=function(){return function(t,e,r){this.guid=t,this.props=e,this.instance=r}}(),a=function(){function t(){}return t.prototype.get=function(t){return s.get(t)},t.prototype.save=function(t,e,r){var n,o=new p(t.guid,e,t);r?((n=s.get(t.guid))?n.view=o:n={setting:null,view:o},s.set(t.guid,n)):((n=s.get(t.guid))?n.setting=o:n={setting:o,view:null},s.set(t.guid,n))},t}();a.decorators=[{type:e.Injectable}],a.ctorParameters=function(){return[]};var u=new e.InjectionToken("DESIGN_COMPONENTS"),c=function(){function t(t){this.props=[],this.pageProps=[],this.fathersProps=[],this.historyKey="historyKey",this.historys=[],this.removePosition=[],this.props=o(t);try{this.backToHistory()}catch(e){localStorage.clear()}}return Object.defineProperty(t.prototype,"settingProps",{get:function(){return this._settingProps},set:function(t){var e=this;this._settingProps=t;try{this._settingProps||(this.fathersProps=[]),this.fathers=this.getFather(this.settingProps),this.fathers&&this.fathers.length>0&&(this.fathersProps=[],this.fathers.map(function(t){var r=e.getPropsByUid(t);r&&e.fathersProps.push(r)}))}catch(r){}},enumerable:!0,configurable:!0}),t.prototype.getPropsByName=function(t){var e;return this.props.forEach(function(r){t===r.name&&(e=r)}),e},t.prototype.addPropByName=function(t,e){var r=this.getPropsByName(t),o=this.deepCopy(r);o.uuid=n(),o.father=e||"",this.pageProps.push(o),this.updateHistory()},t.prototype.addPropsToInstanceByName=function(t){var e=this.getPropsByName(t);if(e){var r=this.deepCopy(e);r.father=this.instance.guid,r.uuid=n(),this.instance.props.children=this.instance.props.children||[],this.instance.props.children.push(r)}},t.prototype.toFatherProps=function(){console.log(this.fathersProps)},t.prototype.deepCopy=function(t){try{return JSON.parse(JSON.stringify(t))}catch(e){console.dir(t)}},t.prototype.isGuid=function(t){return t.indexOf("guid_")>-1},t.prototype.trimGuid=function(t){return t.replace("guid_","")},t.prototype.removePropsByUid=function(t){t=this.trimGuid(t);var e=this.getPropsByUid(t);if(e)if(e.father){var r=this.getPropsByUid(e.father);(n=r.props.children.indexOf(e))>-1&&r.props.children.splice(n,1)}else{var n;(n=this.pageProps.indexOf(e))>-1&&this.pageProps.splice(n,1)}this.updateHistory()},t.prototype.getFather=function(t,e){if(void 0===e&&(e=[]),e.push(t.uuid),t.father){var r=this.getPropsByUid(t.father);r&&(e=this.getFather(r,e))}return e},t.prototype.getPropsByUid=function(t,e){e=e||this.pageProps;for(var r=0;r<e.length;r++){var n=e[r];if(n.uuid+""==t+"")return n;if(n.props.children){var o=this.getPropsByUid(t,n.props.children);if(o)return o}}return!1},t.prototype.getHistory=function(){var t=localStorage.getItem(this.historyKey);return t?JSON.parse(t):[]},t.prototype.updateHistory=function(){this.historys.unshift({name:(new Date).toISOString(),data:this.pageProps}),this.historys.length>50&&(this.historys=this.historys.splice(this.historys.length,this.historys.length-50)),localStorage.setItem(this.historyKey,JSON.stringify(this.historys))},t.prototype.backToHistory=function(t){void 0===t&&(t=null),t||(t=this.getHistory()[0]),this.pageProps=t.data},t}();c.decorators=[{type:e.Injectable}],c.ctorParameters=function(){return[{type:undefined,decorators:[{type:e.Inject,args:[u]}]}]};var h=function(){function t(t){this.components=[],this.components=o(t)}return t.prototype.get=function(t){var e;return this.components.map(function(r){r[t]&&(e=r[t])}),e},t}();h.decorators=[{type:e.Injectable}],h.ctorParameters=function(){return[{type:undefined,decorators:[{type:e.Inject,args:[i]}]}]};var f=new e.InjectionToken("DRAG_DROP_ALL"),d=function(){function t(t,e,r,n,o,i,s,p){this._viewContainerRef=t,this._template=e,this.differs=r,this.librarys=n,this.api=o,this.props=i,this.render=s,this.dragDropAll=p,this.instances=[],this.viewContainerRef=t}return t.prototype.ngDoCheck=function(){var t=this;if(this._differ){var e=this._differ.diff(this.ngComponent);e&&e.forEachOperation(function(e,r,n){if(null==e.previousIndex)t.createComponent(e,n);else if(null==n)t._viewContainerRef.remove(r);else{var o=t._viewContainerRef.get(r);t._viewContainerRef.move(o,n)}})}},t.prototype.createComponent=function(t,r){var o=this;try{var i=t.item;if(i){var s=void 0,p=this.librarys.get(i.name);s=this.ngComponentPreview?p.view:p.setting;var a=this.viewContainerRef.parentInjector,u=(this.moduleRef?this.moduleRef.componentFactoryResolver:a.get(e.ComponentFactoryResolver)).resolveComponentFactory(s),c=this.viewContainerRef.createComponent(u,r,a).instance;i.props&&(c.props=i.props),i.state&&(c.state=i.state),c.onClick.subscribe(function(t){o.ngComponentPreview&&(o.props.settingProps=i,o.props.instance=c)}),c.setClass(this.ngComponentClass),c.setStyle(this.ngComponentStyle),c.instance=this.ngComponentInstance,(this.ngComponentDrag||this.dragDropAll)&&this.setDrage(c),(this.ngComponentDrop||this.dragDropAll)&&this.setDrop(c),i.uuid?c.guid=i.uuid:i.uuid=c.guid=n(),this.api.save(c,i,this.ngComponentPreview)}}catch(h){console.log((this.ngComponentPreview?"preview":"setting")+" is not fond",t),console.dir(h)}},t.prototype.ngOnChanges=function(t){if(this.viewContainerRef.clear(),"ngComponent"in t){var e=t.ngComponent.currentValue;if(e&&!this._differ)try{this._differ=this.differs.find(e).create()}catch(r){}}},t.prototype.setDrage=function(t){t.setAttribute({draggable:!0});var e=t.ele.nativeElement;r.fromEvent(e,"dragstart").subscribe(function(e){t.guid,e.dataTransfer.setData("name","guid_"+t.guid),e.stopPropagation()}),r.fromEvent(e,"dragend").subscribe(function(t){})},t.prototype.isGuid=function(t){return t.indexOf("guid_")>-1},t.prototype.trimGuid=function(t){return t.replace("guid_","")},t.prototype.deepCopy=function(t){try{return JSON.parse(JSON.stringify(t))}catch(e){return console.dir(e),{}}},t.prototype.setDrop=function(t){var e=this,n=t.ele.nativeElement;r.fromEvent(n,"drop").subscribe(function(r){r.preventDefault(),r.stopPropagation();var n=r.dataTransfer.getData("name"),o=e.trimGuid(n);if(e.isGuid(n)){if(o!==t.guid){if(s=e.getInstanceProps(o))(i=e.deepCopy(s)).father=t.guid,t.props.children.push(i)}}else{var i,s=e.props.getPropsByName(n);t.props.children=t.props.children||[],(i=e.deepCopy(s)).father=t.guid,t.props.children.push(i),e.props.instance.props.children.push(i)}}),r.fromEvent(n,"dragleave").subscribe(function(t){e.render.removeStyle(n,"dashed"),t.preventDefault(),t.stopPropagation()}),r.fromEvent(n,"dragover").subscribe(function(t){e.render.setStyle(n,"dashed","1px lodash red"),t.preventDefault(),t.stopPropagation()})},t.prototype.getInstanceProps=function(t){var e;return this.instances.map(function(r){r.guid===t&&(e=r.props)}),e},t}();d.decorators=[{type:e.Directive,args:[{selector:"[ngComponent]"}]}],d.ctorParameters=function(){return[{type:e.ViewContainerRef},{type:e.TemplateRef},{type:e.IterableDiffers},{type:h},{type:a},{type:c},{type:e.Renderer2},{type:undefined,decorators:[{type:e.Inject,args:[f]}]}]},d.propDecorators={ngComponent:[{type:e.Input}],ngComponentPreview:[{type:e.Input}],ngComponentState:[{type:e.Input}],ngComponentClass:[{type:e.Input}],ngComponentStyle:[{type:e.Input}],ngComponentDrag:[{type:e.Input}],ngComponentDrop:[{type:e.Input}],ngComponentInstance:[{type:e.Input}],ngComponentClick:[{type:e.Input}]};var g=function(){function t(){}return t.forRoot=function(e,r){return void 0===r&&(r=!1),{ngModule:t,providers:[{provide:i,useValue:e,multi:!0},{provide:f,useValue:r}]}},t}();g.decorators=[{type:e.NgModule,args:[{imports:[],exports:[d],declarations:[d],providers:[a,h,c]}]}],g.ctorParameters=function(){return[]},t.IDesignComponentModule=g,t.NgComponentDirective=d,t.DesignApiService=a,t.DesignLibraryService=h,t.DESIGN_LIBRARYS=i,t.DesignPropsService=c,t.DESIGN_COMPONENTS=u,t.Éµa=f,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=meepo-idesign-share.umd.min.js.map
